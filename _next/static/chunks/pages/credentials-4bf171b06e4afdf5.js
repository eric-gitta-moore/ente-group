(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2749],{78553:function(t,e,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/credentials",function(){return a(74007)}])},74007:function(t,e,a){"use strict";a.r(e),a.d(e,{default:function(){return Y}});var r=a(52903),i=a(22969),s=a(8700),n=a(10934),o=a(8033),u=a(91430),l=a(98996),d=a(60108),c=a(83446),E=a(63141),w=a(21678),y=a(38045),T=a(27949),P=a(25683),p=a(29650),_=a(50267),R=a(96566),f=a(24991),h=a(5632),A=a(2784),m=a(50193),S=a(34360),k=a(16645),C=a(12595),b=a(52437),Z=a(19764),N=t=>{var e;let{appContext:a}=t,{logout:N,showNavBar:O,setDialogBoxAttributesV2:Y}=a,[v,K]=(0,A.useState)(),[I,B]=(0,A.useState)(),[g,D]=(0,A.useState)(),[L,F]=(0,A.useState)(),[U,W]=(0,A.useState)(),H=(0,h.useRouter)(),x=(0,A.useCallback)(async()=>{try{let t=await (0,b.g)();switch(t.status){case"invalid":Y((0,E.pg)(N));break;case"valid":break;case"validButPasswordChanged":(0,P.a_)(P.Pd.KEY_ATTRIBUTES,t.updatedKeyAttributes),(0,P.a_)(P.Pd.SRP_ATTRIBUTES,t.updatedSRPAttributes),(0,p.Qj)(!0),window.location.reload()}}catch(t){n.ZP.warn("Ignoring error when determining session validity",t)}},[Y,N]);(0,A.useEffect)(()=>{(async()=>{let t=(0,P.Yu)(P.Pd.USER);if(!(null==t?void 0:t.email)){H.push("/");return}D(t);let e=(0,_.km)(_.Qm.ENCRYPTION_KEY),a=globalThis.electron;if(!e&&a){try{e=await a.masterKeyB64()}catch(t){n.ZP.error("Failed to read master key from safe storage",t)}e&&await (0,y.CP)(_.Qm.ENCRYPTION_KEY,e,!0)}let r=(0,p.LP)();if(e&&r){H.push(C.Pm);return}let o=(0,_.km)(_.Qm.KEY_ENCRYPTION_KEY),u=(0,P.Yu)(P.Pd.KEY_ATTRIBUTES),l=(0,P.Yu)(P.Pd.SRP_ATTRIBUTES);if(r&&W(x()),o&&u){(0,_.ud)(_.Qm.KEY_ENCRYPTION_KEY);let t=await (0,i.Lb)(),e=await t.decryptB64(o.encryptedData,o.nonce,o.key);V(await t.decryptB64(u.encryptedKey,u.keyDecryptionNonce,e),e,u);return}if(u){if(!(null==t?void 0:t.token)&&!(null==t?void 0:t.encryptedToken)||u&&!u.memLimit){(0,s.Z)(),H.push("/");return}B(u);return}l?K(l):H.push("/")})(),O(!0)},[]);let Q=async t=>{try{U&&await U;let e=await (0,i.Lb)(),{keyAttributes:a,encryptedToken:r,token:s,id:n,twoFactorSessionID:u,passkeySessionID:l}=await (0,Z.pL)((0,o.zx)(v),t);if((0,p.Qj)(!0),l){let a=await e.generateKeyAndEncryptToB64(t);(0,_.Dt)(_.Qm.KEY_ENCRYPTION_KEY,a);let r=(0,P.Yu)(P.Pd.USER);await (0,P.CA)({...r,passkeySessionID:l,isTwoFactorEnabled:!0,isTwoFactorPasskeysEnabled:!0}),(0,C.M8)("/");let i=(0,k.Yn)(l);throw F({passkeySessionID:l,url:i}),(0,k.$G)({passkeySessionID:l,url:i}),Error(T.sH.TWO_FACTOR_ENABLED)}if(u){let a=await e.generateKeyAndEncryptToB64(t);(0,_.Dt)(_.Qm.KEY_ENCRYPTION_KEY,a);let r=(0,P.Yu)(P.Pd.USER);throw await (0,P.CA)({...r,twoFactorSessionID:u,isTwoFactorEnabled:!0}),H.push(S.q.TWO_FACTOR_VERIFY),Error(T.sH.TWO_FACTOR_ENABLED)}{let t=(0,P.Yu)(P.Pd.USER);return await (0,P.CA)({...t,token:s,encryptedToken:r,id:n,isTwoFactorEnabled:!1}),a&&(0,P.a_)(P.Pd.KEY_ATTRIBUTES,a),a}}catch(t){throw t instanceof Error&&t.message!=T.sH.TWO_FACTOR_ENABLED&&n.ZP.error("getKeyAttributes failed",t),t}},V=async(t,e,a,r)=>{try{var i;(0,p.aF)()&&r&&await (0,y.iv)(r,a,t),await (0,y.CP)(_.Qm.ENCRYPTION_KEY,t),await (0,y.PN)(a,t);try{let t=(0,P.Yu)(P.Pd.SRP_ATTRIBUTES);if(!t&&g&&(t=await (0,m.O3)(g.email))&&(0,P.a_)(P.Pd.SRP_ATTRIBUTES,t),n.ZP.debug(()=>"userSRPSetupPending ".concat(!t)),!t){let t=await (0,y.uA)(e),a=await (0,Z.a4)(t);await (0,Z.Bs)(a)}}catch(t){n.ZP.error("migrate to srp failed",t)}H.push(null!==(i=(0,C.pr)())&&void 0!==i?i:C.Pm)}catch(t){n.ZP.error("useMasterPassword failed",t)}};return I||v?L?globalThis.electron?(0,r.tZ)(E.TJ,{email:null==g?void 0:g.email,passkeySessionID:null==L?void 0:L.passkeySessionID,onRetry:()=>(0,k.$G)(L),logout:N,setDialogBoxAttributesV2:Y}):(0,r.tZ)(u.wx,{children:(0,r.tZ)(l.Z,{})}):(0,r.tZ)(u.wx,{children:(0,r.BX)(d.Z,{style:{minWidth:"320px"},children:[(0,r.tZ)(E.En,{children:null!==(e=null==g?void 0:g.email)&&void 0!==e?e:""}),(0,r.tZ)(w.Z,{buttonText:(0,f.t)("VERIFY_PASSPHRASE"),callback:V,user:g,keyAttributes:I,getKeyAttributes:Q,srpAttributes:v}),(0,r.tZ)(E.AL,{children:(0,r.BX)(R.Z,{direction:"row",justifyContent:"space-between",children:[(0,r.tZ)(c.Z,{onClick:()=>H.push(S.q.RECOVER),children:(0,f.t)("FORGOT_PASSWORD")}),(0,r.tZ)(c.Z,{onClick:N,children:(0,f.t)("CHANGE_EMAIL")})]})})]})}):(0,r.tZ)(u.wx,{children:(0,r.tZ)(l.Z,{})})},O=a(55005),Y=()=>(0,r.tZ)(N,{appContext:(0,O.useAppContext)()})},52437:function(t,e,a){"use strict";a.d(e,{g:function(){return l}});var r=a(58034),i=a(62860),s=a(68351),n=a(8033),o=a(25683),u=a(50193);let l=async()=>{let t=await fetch(await (0,s.QH)("/users/session-validity/v2"),{headers:await (0,r.Qk)()});if(!t.ok){if(401==t.status)return{status:"invalid"};throw new r.Bb(t)}let e=await t.json();if("keyAttributes"in e&&"object"==typeof e.keyAttributes&&null!==e.keyAttributes){let t=e.keyAttributes,a=(0,i.Fd)().email,r=(0,n.zx)((0,o.Yu)(o.Pd.SRP_ATTRIBUTES)),s=await (0,u.O3)(a);if(s&&s.kekSalt!=r.kekSalt)return{status:"validButPasswordChanged",updatedKeyAttributes:t,updatedSRPAttributes:s}}return{status:"valid"}}},21678:function(t,e,a){"use strict";a.d(e,{Z:function(){return d}});var r=a(52903),i=a(22969),s=a(10934),n=a(84381),o=a(24991),u=a(50006),l=a(27949);function d(t){let{user:e,keyAttributes:a,srpAttributes:d,callback:c,buttonText:E,submitButtonProps:w,getKeyAttributes:y}=t,T=async(t,e)=>{try{let e;let r=await (0,i.Lb)();try{if(d)e=await r.deriveKey(t,d.kekSalt,d.opsLimit,d.memLimit);else if(a)e=await r.deriveKey(t,a.kekSalt,a.opsLimit,a.memLimit);else throw Error("Both SRP and key attributes are missing")}catch(t){throw s.ZP.error("failed to derive key",t),Error(l.sH.WEAK_DEVICE)}if(a||"function"!=typeof y||(a=await y(e)),!a)throw Error("couldn't get key attributes");try{let i=await r.decryptB64(a.encryptedKey,a.keyDecryptionNonce,e);c(i,e,a,t)}catch(t){throw s.ZP.error("user entered a wrong password",t),Error(l.sH.INCORRECT_PASSWORD)}}catch(t){if(t instanceof Error){if(t.message===l.sH.TWO_FACTOR_ENABLED)return;switch(s.ZP.error("failed to verify passphrase",t),t.message){case l.sH.WEAK_DEVICE:e((0,o.t)("WEAK_DEVICE"));break;case l.sH.INCORRECT_PASSWORD:e((0,o.t)("INCORRECT_PASSPHRASE"));break;default:e("".concat((0,o.t)("UNKNOWN_ERROR")," ").concat(t.message))}}}};return(0,r.tZ)(u.Z,{callback:T,placeholder:(0,o.t)("password"),buttonText:E,submitButtonProps:w,hiddenPreInput:(0,r.tZ)(n.Z,{sx:{display:"none"},id:"email",name:"email",autoComplete:"username",type:"email",value:null==e?void 0:e.email}),autoComplete:"current-password",fieldType:"password"})}}},function(t){t.O(0,[1981,1708,4373,3432,3692,6702,5929,2888,9774,179],function(){return t(t.s=78553)}),_N_E=t.O()}]);