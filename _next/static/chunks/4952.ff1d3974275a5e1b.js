!function(){var e,t,a,r,i,n,o={60373:function(e,t,a){"use strict";a.d(t,{SL:function(){return o},nI:function(){return i}});var r=a(93542);let i=!1,n=r.env.desktopAppVersion,o=(()=>{if(i){if(!n)throw Error("desktopAppVersion is not defined");return"io.ente.photos.desktop/".concat(n)}return"io.ente.photos.web"})()},86617:function(e,t,a){"use strict";a.d(t,{iO:function(){return n},lE:function(){return r},ly:function(){return i}});let r=!1,i=()=>!0,n=()=>"function"==typeof importScripts},59545:function(e,t,a){"use strict";a.d(t,{j:function(){return r}});let r=(0,a(90758).Ud)(globalThis)},64952:function(e,t,a){"use strict";let r,i,n,o,l;var s,c,d,u,h,f,w,m,p=a(60373),g=a(86617),y=a(10934);let b=e=>{if(e=null!=e?e:"Assertion failed",g.lE)throw Error(e);y.ZP.warn(e)};var v=a(8033),T=a(30195),E=a(18762);let x=async()=>{let e=await (0,E.X3)("kv",1,{upgrade(e){e.createObjectStore("kv")},blocking(){y.ZP.info("Another client is attempting to open a new version of KV DB"),e.close(),r=void 0},blocked(){y.ZP.warn("Waiting for an existing client to close their connection so that we can update the KV DB version")},terminated(){y.ZP.warn("Our connection to KV DB was unexpectedly terminated"),r=void 0}});return e},P=()=>null!=r?r:r=x(),I=async e=>(await P()).get("kv",e),D=async(e,t)=>{let a=await P(),r=await a.get("kv",e);if(void 0!==r){if(typeof r!=t)throw Error("Expected the value corresponding to key ".concat(e," to be a ").concat(t,", but instead got ").concat(String(r)));return r}},S=async e=>D(e,"string"),O=async e=>D(e,"number"),A=async(e,t)=>{let a=await P();await a.put("kv",t,e)};T.z.object({id:T.z.number(),email:T.z.string(),token:T.z.string()});let L=async()=>(0,v.zx)(await S("token")),R=async()=>({"X-Auth-Token":await L(),"X-Client-Package":p.SL});class _ extends Error{constructor(e){let t=new URL(e.url);t.search="",super("Fetch failed: ".concat(t.href,": HTTP ").concat(e.status," ").concat(e.statusText)),Error.captureStackTrace&&Error.captureStackTrace(this,_),this.name=this.constructor.name,this.res=e}}let k=e=>{if(!e.ok)throw new _(e)},U=e=>e instanceof _&&e.res.status>=400&&e.res.status<=499,M={NotAvailable:"This feature in not available on the current OS/arch"};var N=a(59545);let F=["arw","cr2","cr3","dng","heic","jp2","nef","psd","rw2","tif","tiff"],z=e=>F.includes(e.toLowerCase());var C=a(50507),j=a(90758);class B{terminate(){this.worker.terminate(),y.ZP.debug(()=>"Terminated ".concat(this.name," web worker"))}constructor(e,t){this.name=e,this.worker=t,t.onerror=t=>{y.ZP.error("Got error event from worker: ".concat(JSON.stringify({event:t,name:e})))},y.ZP.debug(()=>"Created ".concat(e," web worker"));let a=(0,j.Ud)(t);this.remote=new a,(0,j.Jj)(G,t)}}let G={logToDisk:y.Q2,convertToJPEG:e=>(0,C.M)().convertToJPEG(e)},H=e=>new Promise(t=>setTimeout(t,e)),Z=async e=>W().then(t=>t.heicToJPEG(e)).then(e=>H(10).then(()=>e)),W=async()=>(null!=i?i:i=K()).remote,K=()=>new B("heic-convert-worker",new Worker(a.tu(new URL(a.p+a.u(8284),a.b)))),q=e=>{let t=e.lastIndexOf(".");return -1==t||0==t?[e,void 0]:[e.slice(0,t),e.slice(t+1)]},X=e=>{let[,t]=q(e);return null==t?void 0:t.toLowerCase()},J=e=>e.filter(e=>!!e).join("."),Q=e=>{let t=e.split("/");for(let e=t.length-1;e>=0;e--){let a=t[e];if(a&&a.length>0)return a}return e};(s=h||(h={}))[s.image=0]="image",s[s.video=1]="video",s[s.livePhoto=2]="livePhoto",s[s.other=3]="other";let V=[{fileType:0,extension:"jpeg",mimeType:"image/jpeg"},{fileType:0,extension:"jpg",mimeType:"image/jpeg"},{fileType:1,extension:"webm",mimeType:"video/webm"},{fileType:1,extension:"mod",mimeType:"video/mpeg"},{fileType:1,extension:"mp4",mimeType:"video/mp4"},{fileType:0,extension:"gif",mimeType:"image/gif"},{fileType:1,extension:"dv",mimeType:"video/x-dv"},{fileType:1,extension:"wmv",mimeType:"video/x-ms-asf"},{fileType:1,extension:"hevc",mimeType:"video/hevc"},{fileType:0,extension:"raf",mimeType:"image/x-fuji-raf"},{fileType:0,extension:"orf",mimeType:"image/x-olympus-orf"},{fileType:0,extension:"crw",mimeType:"image/x-canon-crw"},{fileType:1,extension:"mov",mimeType:"video/quicktime"}],Y=["xmp","html","txt"];var $=a(27949),ee=a(5025),et=a.n(ee);let ea=async e=>er(()=>ei(e),e.name),er=async(e,t)=>{try{let t;let a=await en(await e()),r=a.mime;if(r.startsWith("image/"))t=h.image;else if(r.startsWith("video/"))t=h.video;else throw Error($.sH.UNSUPPORTED_FILE_FORMAT);return{fileType:t,extension:a.ext,mimeType:r}}catch(r){let e=X(t),a=V.find(t=>t.extension==e);if(a)return a;if(e&&Y.includes(e))throw Error($.sH.UNSUPPORTED_FILE_FORMAT);throw r}},ei=async e=>{let t=e.slice(0,4100);return new Uint8Array(await t.arrayBuffer())},en=async e=>{let t=await et().fromBuffer(e);if(!t)throw Error("Could not deduce file type from the file's contents");return t},eo=!0,el=e=>{var t;return"file ".concat(null!==(t=e.metadata.title)&&void 0!==t?t:"-"," (").concat(e.id,")")},es=e=>e.map(e=>ec(e)),ec=e=>{var t;let a=null===(t=e.pubMagicMetadata)||void 0===t?void 0:t.data;if(a){let{editedTime:t,editedName:r,lat:i,long:n}=a;t&&(e.metadata.creationTime=t),r&&(e.metadata.title=r),i&&n&&(e.metadata.latitude=i,e.metadata.longitude=n)}return e.metadata.modificationTime||(e.metadata.modificationTime=e.metadata.creationTime),e},ed=async(e,t)=>{try{let a=new File([t],e),r=await ea(a),{extension:i,mimeType:n}=r;if(y.ZP.debug(()=>["Get renderable blob",{fileName:e,...r}]),z(i)){if(p.nI&&eo)try{return await eu(t)}catch(e){e instanceof Error&&e.message.endsWith(M.NotAvailable)?eo=!1:y.ZP.error("Native conversion to JPEG failed",e)}if("heic"==i||"heif"==i)return await Z(t)}if(!n)return y.ZP.info("Attempting to get renderable blob for a file without a MIME type",e),t;return new Blob([t],{type:n})}catch(a){return y.ZP.error("Failed to get renderable blob for ".concat(e,", will fallback to the original"),a),t}},eu=async e=>{let t=Date.now(),a=new Uint8Array(await e.arrayBuffer()),r=globalThis.electron,i=r?await r.convertToJPEG(a):await N.j.convertToJPEG(a);return y.ZP.debug(()=>"Native JPEG conversion took ".concat(Date.now()-t," ms")),new Blob([i],{type:"image/jpeg"})};var eh=a(72751),ef=a.n(eh);let ew=new Map,em=async e=>{let t=ew.get(e);return t||ew.set(e,t=await ep(e)),t},ep=async e=>ef()()?ey(e):eg(e),eg=async e=>{let t=await caches.open(e);return{get:async e=>{let a=await t.match(e);return await (null==a?void 0:a.blob())},has:async e=>t.match(e).then(e=>!!e),put:(e,a)=>t.put(e,new Response(a)),delete:e=>t.delete(e)}},ey=async e=>{let t=await navigator.storage.getDirectory(),a=await t.getDirectoryHandle("cache",{create:!0}),r=await a.getDirectoryHandle(e,{create:!0});return{get:async e=>{try{let t=await r.getFileHandle(e);return await t.getFile()}catch(e){if(e instanceof DOMException&&"NotFoundError"==e.name)return;throw e}},has:async e=>{try{return await r.getFileHandle(e),!0}catch(e){if(e instanceof DOMException&&"NotFoundError"==e.name)return!1;throw e}},put:async(e,t)=>{let a=await r.getFileHandle(e,{create:!0}),i=await a.createWritable();await i.write(t),await i.close()},delete:async e=>{try{return await r.removeEntry(e),!0}catch(e){if(e instanceof DOMException&&"NotFoundError"==e.name)return!1;throw e}}}};var eb=a(84836);let ev=eb.L7;eb.jK;let eT=eb.hk;eb.L$;let eE=eb.ZN,ex=eb.KL;eb.WF;let eP=async()=>(null!=n?n:n=eI()).remote,eI=()=>new B("crypto",new Worker(a.tu(new URL(a.p+a.u(8354),a.b))));eb.eT;let eD=eb.nE,eS=(e,t)=>(0,g.iO)()?ev(e,t):eP().then(a=>a.encryptBoxB64(e,t)),eO=(e,t)=>(0,g.iO)()?eT(e,t):eP().then(a=>a._encryptBlobB64(e,t)),eA=(e,t)=>(0,g.iO)()?eE(e,t):eP().then(a=>a.decryptBoxB64(e,t)),eL=(e,t)=>(0,g.iO)()?ex(e,t):eP().then(a=>a.decryptBlob(e,t));a(93542);let eR=async()=>{var e;return null!==(e=await ek())&&void 0!==e?e:"https://api.ente.io"},e_=async(e,t)=>{let a=await eR()+e;if(t){let e=new URLSearchParams(t);a="".concat(a,"?").concat(e.toString())}return a},ek=async()=>{var e,t;return null!==(t=null!==(e=await S("apiOrigin"))&&void 0!==e?e:"https://ente.tianhaoltd.top/api")&&void 0!==t?t:void 0};var eU=a(1297),eM=a.n(eU);let eN=async(e,t)=>{let a,r,i,n;let[o]=q(e),l=await eM().loadAsync(t,{createFolders:!0});for(let e in l.files){var s,c;if(e.startsWith("image")){let[,t]=q(e);a=J([o,t]),i=await (null===(s=l.files[e])||void 0===s?void 0:s.async("uint8array"))}else if(e.startsWith("video")){let[,t]=q(e);r=J([o,t]),n=await (null===(c=l.files[e])||void 0===c?void 0:c.async("uint8array"))}}if(!a||!i||!r||!n)throw Error("Decoded live photo ".concat(e," does not have an image"));return{imageFileName:a,imageData:i,videoFileName:r,videoData:n}};(c=f||(f={}))[c.visible=0]="visible",c[c.archived=1]="archived",c[c.hidden=2]="hidden",T.z.object({editedTime:T.z.number().optional()}).passthrough(),(d=w||(w={}))[d.START=0]="START",d[d.READING_GOOGLE_METADATA_FILES=1]="READING_GOOGLE_METADATA_FILES",d[d.EXTRACTING_METADATA=2]="EXTRACTING_METADATA",d[d.UPLOADING=3]="UPLOADING",d[d.CANCELLING=4]="CANCELLING",d[d.FINISH=5]="FINISH",(u=m||(m={}))[u.FAILED=0]="FAILED",u[u.ALREADY_UPLOADED=1]="ALREADY_UPLOADED",u[u.UNSUPPORTED=2]="UNSUPPORTED",u[u.BLOCKED=3]="BLOCKED",u[u.TOO_LARGE=4]="TOO_LARGE",u[u.LARGER_THAN_AVAILABLE_STORAGE=5]="LARGER_THAN_AVAILABLE_STORAGE",u[u.UPLOADED=6]="UPLOADED",u[u.UPLOADED_WITH_STATIC_THUMBNAIL=7]="UPLOADED_WITH_STATIC_THUMBNAIL",u[u.ADDED_SYMLINK=8]="ADDED_SYMLINK";let eF=async(e,t)=>{let a;if("string"==typeof t){let e=new URLSearchParams({path:t});a=new URL("stream://read?".concat(e.toString()))}else{let[e,r]=t,i=new URLSearchParams({zipPath:e,entryName:r});a=new URL("stream://read-zip?".concat(i.toString()))}let r=new Request(a,{method:"GET"}),i=await fetch(r);if(!i.ok)throw Error("Failed to read stream from ".concat(a.href,": HTTP ").concat(i.status));let n=ez(i,"Content-Length"),o=ez(i,"X-Last-Modified-Ms");return{response:i,size:n,lastModifiedMs:o}},ez=(e,t)=>{let a=e.headers.get(t),r=null===a?NaN:+a;if(isNaN(r))throw Error("Expected a numeric ".concat(t," when reading a stream response, instead got ").concat(a));return r},eC=async(e,t)=>{let a="stream://convert-to-mp4",r=new Request(a,{method:"POST",body:t,duplex:"half"}),i=await fetch(r);if(!i.ok)throw Error("Failed to write stream to ".concat(a,": HTTP ").concat(i.status));return i.text()},ej=async(e,t)=>{let a=new URLSearchParams({token:t}),r=new URL("stream://convert-to-mp4?".concat(a.toString())),i=new Request(r,{method:"GET"}),n=await fetch(i);if(!n.ok)throw Error("Failed to read stream from ".concat(r.href,": HTTP ").concat(n.status));return n.blob()},eB=async(e,t)=>{let a=new URLSearchParams({token:t,done:"1"}),r=new URL("stream://convert-to-mp4?".concat(a.toString())),i=new Request(r,{method:"GET"}),n=await fetch(i);if(!n.ok)throw Error("Failed to close stream at ".concat(r.href,": HTTP ").concat(n.status))},eG=async(e,t,a)=>{let r=await eK.lazy();return await r.exec(e,t,a)},eH=async e=>{let t=globalThis.electron;return t?eZ(t,e):eG(["FFMPEG","-i","INPUT","-preset","ultrafast","OUTPUT"],e,"mp4")},eZ=async(e,t)=>{let a=await eC(e,t),r=await ej(e,a);return await eB(e,a),r};class eW{async lazy(){return this.instance||(this.instance=this.createComlinkWorker().remote),this.instance}constructor(){this.createComlinkWorker=()=>new B("ffmpeg-worker",new Worker(a.tu(new URL(a.p+a.u(9594),a.b))))}}let eK=new eW;async function eq(e){return await new Promise(t=>{let a=setTimeout(()=>{t(!1)},1e3),r=document.createElement("video");r.addEventListener("canplay",function(){clearTimeout(a),r.remove(),r.duration>0?t(!0):t(!1)}),r.addEventListener("error",function(){clearTimeout(a),r.remove(),t(!1)}),r.src=e})}var eX=a(60418);class eJ{setHeaders(e){this.headers={...this.headers,...e}}appendHeader(e,t){this.headers={...this.headers,[e]:t}}removeHeader(e){this.headers[e]=void 0}getInterceptors(){return eX.default.interceptors}async request(e,t){return e.headers={...this.headers,...e.headers},(null==t?void 0:t.cancel)&&(e.cancelToken=new eX.default.CancelToken(e=>t.cancel.exec=e)),await (0,eX.default)({...e,...t})}get(e,t,a,r){return this.request({headers:a,method:"GET",params:t,url:e},r)}post(e,t,a,r,i){return this.request({data:t,headers:r,method:"POST",params:a,url:e},i)}patch(e,t,a,r,i){return this.request({data:t,headers:r,method:"PATCH",params:a,url:e},i)}put(e,t,a,r,i){return this.request({data:t,headers:r,method:"PUT",params:a,url:e},i)}delete(e,t,a,r,i){return this.request({data:t,headers:r,method:"DELETE",params:a,url:e},i)}constructor(){this.headers={"content-type":"application/json"},eX.default.interceptors.response.use(e=>Promise.resolve(e),e=>{let t=e.config;if(e.response){let a;let r=e.response;if((0,$.Rp)(r.data)){let i=r.data;y.ZP.error("HTTP Service Error - ".concat(JSON.stringify({url:null==t?void 0:t.url,method:null==t?void 0:t.method,xRequestId:r.headers["x-request-id"],httpStatus:r.status,errMessage:i.message,errCode:i.code})),e),a=new $.MS(i.message,i.code,r.status)}else a=r.status>=400&&r.status<500?new $.MS($.sH.CLIENT_ERROR,"",r.status):new $.MS($.sH.ServerError,"",r.status);throw y.ZP.error("HTTP Service Error - ".concat(JSON.stringify({url:t.url,method:t.method,cfRay:r.headers["cf-ray"],xRequestId:r.headers["x-request-id"],httpStatus:r.status})),a),a}return e.request?y.ZP.info("request failed - no response (".concat(t.method," ").concat(t.url)):y.ZP.info("request failed - axios error (".concat(t.method," ").concat(t.url)),Promise.reject(e)})}}var eQ=new eJ;async function eV(e,t){t||(t=[2e3,5e3,1e4]);for(let a=0;a<=t.length;a++)try{return await e()}catch(e){if(a===t.length)throw e;await H((0,v.zx)(t[a]))}}class eY{async init(e){if(this.ready){y.ZP.info("DownloadManager already initialized");return}this.downloadClient=e0(e);try{this.thumbnailCache=await em("thumbs")}catch(e){y.ZP.error("Failed to open thumbnail cache, will continue without it",e)}this.cryptoWorker=await eP(),this.ready=!0}ensureInitialized(){if(!this.ready)throw Error("Attempting to use an uninitialized download manager");return{downloadClient:(0,v.zx)(this.downloadClient),cryptoWorker:(0,v.zx)(this.cryptoWorker)}}logout(){this.ready=!1,this.cryptoWorker=void 0,this.downloadClient=void 0,this.fileObjectURLPromises.clear(),this.fileConversionPromises.clear(),this.thumbnailObjectURLPromises.clear(),this.fileDownloadProgress.clear(),this.progressUpdater=()=>{}}updateToken(e,t){let{downloadClient:a}=this.ensureInitialized();a.updateTokens(e,t)}setProgressUpdater(e){this.progressUpdater=e}async getThumbnail(e){var t,a;let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.ensureInitialized();let i=e.id.toString(),n=await (null===(t=this.thumbnailCache)||void 0===t?void 0:t.get(i));if(n)return new Uint8Array(await n.arrayBuffer());if(r)return;let o=await this.downloadThumb(e);return await (null===(a=this.thumbnailCache)||void 0===a?void 0:a.put(i,new Blob([o]))),o}async getThumbnailForPreview(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.ensureInitialized();try{if(!this.thumbnailObjectURLPromises.has(e.id)){let a=this.getThumbnail(e,t).then(e=>e&&URL.createObjectURL(new Blob([e])));this.thumbnailObjectURLPromises.set(e.id,a)}let a=await this.thumbnailObjectURLPromises.get(e.id);return a||t||(this.thumbnailObjectURLPromises.delete(e.id),a=await this.getThumbnailForPreview(e,t)),a}catch(t){throw this.thumbnailObjectURLPromises.delete(e.id),y.ZP.error("get DownloadManager preview Failed",t),t}}async getFile(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.ensureInitialized();try{let a=async()=>{let t=await this.downloadFile(e),a=await new Response(t).blob();return{url:URL.createObjectURL(a),isOriginal:!0,isRenderable:!1,type:"normal"}};if(!this.fileObjectURLPromises.has(e.id)){if(!t)return await this.downloadFile(e);this.fileObjectURLPromises.set(e.id,a())}let r=(0,v.zx)(await this.fileObjectURLPromises.get(e.id));if(r.isOriginal)return(await fetch(r.url)).body;return await this.downloadFile(e)}catch(t){throw this.fileObjectURLPromises.delete(e.id),y.ZP.error("download manager getFile Failed",t),t}}async downloadFile(e){var t,a,r,i,n,o;let l;let{downloadClient:s,cryptoWorker:c}=this.ensureInitialized();y.ZP.info("download attempted for file id ".concat(e.id));let d=this.trackDownloadProgress(e.id,null!==(r=null===(t=e.info)||void 0===t?void 0:t.fileSize)&&void 0!==r?r:0),u=e.id.toString();if(e.metadata.fileType===h.image||e.metadata.fileType===h.livePhoto){let t=await (null===(i=this.fileCache)||void 0===i?void 0:i.get(u)),a=await (null==t?void 0:t.arrayBuffer());a||(a=(await s.downloadFile(e,d)).buffer,await (null===(n=this.fileCache)||void 0===n?void 0:n.put(u,new Blob([a])))),this.clearDownloadProgress(e.id);try{let t=await c.decryptFile(new Uint8Array(a),await c.fromB64(e.file.decryptionHeader),e.key);return new Response(t).body}catch(t){throw t instanceof Error&&t.message==$.sH.PROCESSING_FAILED&&y.ZP.error("Failed to process file with fileID:".concat(e.id,", localID: ").concat(e.metadata.localID,", version: ").concat(e.metadata.version,", deviceFolder:").concat(e.metadata.deviceFolder),t),t}}let f=await (null===(a=this.fileCache)||void 0===a?void 0:a.get(u)),w=(l=f?new Response(f):await s.downloadFileStream(e)).body;if(!w)return null;let m=w.getReader(),p=parseInt(null!==(o=l.headers.get("Content-Length"))&&void 0!==o?o:"")||0,g=0,b=await c.fromB64(e.file.decryptionHeader),v=await c.fromB64(e.key),{pullState:T,decryptionChunkSize:E}=await c.initChunkDecryption(b,v),x=new Uint8Array;return new ReadableStream({pull:async e=>{let t=!1;do{let a;let{done:r,value:i}=await m.read();for(r?a=x:(d({loaded:g+=i.length,total:p}),(a=new Uint8Array(x.length+i.length)).set(new Uint8Array(x),0),a.set(new Uint8Array(i),x.length));a.length>=E;){let{decryptedData:r}=await c.decryptFileChunk(a.slice(0,E),T);e.enqueue(r),t=!0,a=a.slice(E)}if(r){if(a.length){let{decryptedData:t}=await c.decryptFileChunk(a,T);e.enqueue(t)}t=!0,e.close()}else x=a}while(!t)}})}constructor(){this.ready=!1,this.fileObjectURLPromises=new Map,this.fileConversionPromises=new Map,this.thumbnailObjectURLPromises=new Map,this.fileDownloadProgress=new Map,this.progressUpdater=()=>{},this.downloadThumb=async e=>{let{downloadClient:t,cryptoWorker:a}=this.ensureInitialized(),r=await t.downloadThumbnail(e),i=e.thumbnail.decryptionHeader;return a.decryptThumbnail({encryptedData:r,decryptionHeader:i},e.key)},this.getFileForPreview=async(e,t)=>{this.ensureInitialized();try{var a;let r=null!==(a=null==t?void 0:t.forceConvertVideos)&&void 0!==a&&a,i=async()=>{let t=await new Response(await this.getFile(e,!0)).blob(),{url:a}=(0,v.zx)(await this.fileObjectURLPromises.get(e.id));return await e1(e,t,a,r)};return(r||!this.fileConversionPromises.has(e.id))&&this.fileConversionPromises.set(e.id,i()),await this.fileConversionPromises.get(e.id)}catch(t){throw this.fileConversionPromises.delete(e.id),y.ZP.error("download manager getFileForPreview Failed",t),t}},this.trackDownloadProgress=(e,t)=>a=>{if(isNaN(a.total)||0===a.total){if(!t)return;a.total=t}a.loaded===a.total?this.fileDownloadProgress.delete(e):this.fileDownloadProgress.set(e,Math.round(100*a.loaded/a.total)),this.progressUpdater(new Map(this.fileDownloadProgress))},this.clearDownloadProgress=e=>{this.fileDownloadProgress.delete(e),this.progressUpdater(new Map(this.fileDownloadProgress))}}}let e$=new eY,e0=e=>e?new e4(e,3e5):new e3(3e5);async function e1(e,t,a,r){let i,n,o,l;let s=e=>e?e===t?a:URL.createObjectURL(e):void 0,c="normal";switch(e.metadata.fileType){case h.image:{let r=await ed(e.metadata.title,t),c=s(r);i=c,n=c===a,o=!!c,l=r.type;break}case h.livePhoto:i=await e2(e,t),n=!1,o=!1,c="livePhoto";break;case h.video:{let c=await e5(e.metadata.title,t,r),d=s(c);i=d,n=d===a,o=!!d,l=null==c?void 0:c.type;break}default:i=a,n=!0,o=!1}return{url:(0,v.zx)(i),isOriginal:n,isRenderable:o,type:c,mimeType:l}}async function e2(e,t){let a=await eN(e.metadata.title,t);return{image:async()=>{try{let e=new Blob([a.imageData]);return URL.createObjectURL(await ed(a.imageFileName,e))}catch(e){return}},video:async()=>{try{let e=new Blob([a.videoData]),t=await e5(a.videoFileName,e,!1);if(!t)return;return URL.createObjectURL(t)}catch(e){return}}}}async function e5(e,t,a){let r=async()=>{try{y.ZP.info("Converting video ".concat(e," to mp4"));let a=await eH(t);return new Blob([a],{type:"video/mp4"})}catch(e){return y.ZP.error("Video conversion failed",e),null}};return a?r():await eq(URL.createObjectURL(t))?t:p.nI?r():t.size>104857600?null:r()}class e4{updateTokens(e){this.token=e}async downloadThumbnail(e){let t=this.token;if(!t)throw Error($.sH.TOKEN_MISSING);let a=await ek(),r=await eV(()=>{let r={responseType:"arraybuffer",timeout:this.timeout};if(!a)return eQ.get("https://thumbnails.ente.io/?fileID=".concat(e.id),void 0,{"X-Auth-Token":t},r);{let i=new URLSearchParams({token:t});return eQ.get("".concat(a,"/files/preview/").concat(e.id,"?").concat(i.toString()),void 0,void 0,r)}});if(void 0===r.data)throw Error($.sH.REQUEST_FAILED);return new Uint8Array(r.data)}async downloadFile(e,t){let a=this.token;if(!a)throw Error($.sH.TOKEN_MISSING);let r=await ek(),i=await eV(()=>{let i={responseType:"arraybuffer",timeout:this.timeout,onDownloadProgress:t};if(!r)return eQ.get("https://files.ente.io/?fileID=".concat(e.id),void 0,{"X-Auth-Token":a},i);{let t=new URLSearchParams({token:a});return eQ.get("".concat(r,"/files/download/").concat(e.id,"?").concat(t.toString()),void 0,void 0,i)}});if(void 0===i.data)throw Error($.sH.REQUEST_FAILED);return new Uint8Array(i.data)}async downloadFileStream(e){let t=this.token;if(!t)throw Error($.sH.TOKEN_MISSING);let a=await ek();return eV(()=>{if(!a)return fetch("https://files.ente.io/?fileID=".concat(e.id),{headers:{"X-Auth-Token":t}});{let r=new URLSearchParams({token:t});return fetch("".concat(a,"/files/download/").concat(e.id,"?").concat(r.toString()))}})}constructor(e,t){this.token=e,this.timeout=t}}class e3{updateTokens(e,t){this.token=e,this.passwordToken=t}async downloadFileStream(e){let t=this.token,a=this.passwordToken;if(!t)throw Error($.sH.TOKEN_MISSING);let r=await ek();return eV(()=>{if(!r)return fetch("https://public-albums.ente.io/download/?fileID=".concat(e.id),{headers:{"X-Auth-Access-Token":t,...a&&{"X-Auth-Access-Token-JWT":a}}});{let i=new URLSearchParams({accessToken:t,...a&&{accessTokenJWT:a}});return fetch("".concat(r,"/public-collection/files/download/").concat(e.id,"?").concat(i.toString()))}})}constructor(e){this.timeout=e,this.downloadThumbnail=async e=>{let t=this.token,a=this.passwordToken;if(!t)throw Error($.sH.TOKEN_MISSING);let r=await ek(),i=await (()=>{let i={responseType:"arraybuffer"};if(!r)return eQ.get("https://public-albums.ente.io/preview/?fileID=".concat(e.id),void 0,{"X-Auth-Access-Token":t,...a&&{"X-Auth-Access-Token-JWT":a}},i);{let n=new URLSearchParams({accessToken:t,...a&&{accessTokenJWT:a}});return eQ.get("".concat(r,"/public-collection/files/preview/").concat(e.id,"?").concat(n.toString()),void 0,void 0,i)}})();if(void 0===i.data)throw Error($.sH.REQUEST_FAILED);return new Uint8Array(i.data)},this.downloadFile=async(e,t)=>{let a=this.token,r=this.passwordToken;if(!a)throw Error($.sH.TOKEN_MISSING);let i=await ek(),n=await eV(()=>{let n={responseType:"arraybuffer",timeout:this.timeout,onDownloadProgress:t};if(!i)return eQ.get("https://public-albums.ente.io/download/?fileID=".concat(e.id),void 0,{"X-Auth-Access-Token":a,...r&&{"X-Auth-Access-Token-JWT":r}},n);{let t=new URLSearchParams({accessToken:a,...r&&{accessTokenJWT:r}});return eQ.get("".concat(i,"/public-collection/files/download/").concat(e.id,"?").concat(t.toString()),void 0,void 0,n)}});if(void 0===n.data)throw Error($.sH.REQUEST_FAILED);return new Uint8Array(n.data)}}}var e8=a(75486),e9=a.n(e8);(0,g.ly)()&&e9().config({name:"ente-files",version:1,storeName:"files"});var e7=e9();let e6=async()=>(await te("normal")).concat(await te("hidden")),te=async function(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"normal";return null!==(e=await e7.getItem("normal"===t?"files":"hidden-files"))&&void 0!==e?e:[]};async function tt(){var e;return null!==(e=await e7.getItem("file-trash"))&&void 0!==e?e:[]}async function ta(){return tr(es((await tt()).map(e=>({...e.file,updationTime:e.updatedAt,deleteBy:e.deleteBy,isTrashed:!0}))))}let tr=e=>e.sort((e,t)=>{var a,r;return e.deleteBy===t.deleteBy?e.metadata.creationTime===t.metadata.creationTime?t.metadata.modificationTime-e.metadata.modificationTime:t.metadata.creationTime-e.metadata.creationTime:(null!==(a=e.deleteBy)&&void 0!==a?a:0)-(null!==(r=t.deleteBy)&&void 0!==r?r:0)}),ti=async e=>{let t=await createImageBitmap(e),{width:a,height:r}=t,i=new OffscreenCanvas(a,r),n=(0,v.zx)(i.getContext("2d"));return n.drawImage(t,0,0,a,r),{bitmap:t,data:n.getImageData(0,0,a,r)}},tn=async(e,t,a)=>t?await to(e,t,a):await ts(e),to=async(e,t,a)=>{if(e.metadata.fileType==h.video){let t=await e$.getThumbnail(e);return new Blob([(0,v.zx)(t)])}{let r=await tl(t,a);return ed(e.metadata.title,r)}},tl=async(e,t)=>{if("string"==typeof e||Array.isArray(e)){let{response:a,lastModifiedMs:r}=await eF(t,e),i="string"==typeof e?e:e[1];return new File([await a.arrayBuffer()],Q(i),{lastModified:r})}return e instanceof File?e:e.file},ts=async e=>{let t=e.metadata.fileType;if(t==h.video){let t=await e$.getThumbnail(e);return new Blob([(0,v.zx)(t)])}let a=await e$.getFile(e),r=await new Response(a).blob();if(t==h.livePhoto){let{imageFileName:t,imageData:a}=await eN(e.metadata.title,r);return ed(t,new Blob([a]))}if(t==h.image)return await ed(e.metadata.title,r);throw Error("Cannot index unsupported file type ".concat(t))},tc=async()=>{let e=await (0,E.X3)("ml",1,{upgrade(e,t,a){y.ZP.info("Upgrading ML DB ".concat(t," => ").concat(a)),t<1&&(e.createObjectStore("file-status",{keyPath:"fileID"}).createIndex("status","status"),e.createObjectStore("face-index",{keyPath:"fileID"}),e.createObjectStore("clip-index",{keyPath:"fileID"}),e.createObjectStore("face-cluster",{keyPath:"id"}),e.createObjectStore("cluster-group",{keyPath:"id"}))},blocking(){y.ZP.info("Another client is attempting to open a new version of ML DB"),e.close(),o=void 0},blocked(){y.ZP.warn("Waiting for an existing client to close their connection so that we can update the ML DB version")},terminated(){y.ZP.warn("Our connection to ML DB was unexpectedly terminated"),o=void 0}});return e},td=()=>null!=o?o:o=tc(),tu=async(e,t)=>{let{fileID:a}=e,r=(await td()).transaction(["file-status","face-index","clip-index"],"readwrite");await Promise.all([r.objectStore("file-status").put({fileID:a,status:"indexed",failureCount:0}),r.objectStore("face-index").put(e),r.objectStore("clip-index").put(t),r.done])},th=e=>({fileID:e,status:"indexable",failureCount:0}),tf=async()=>{let e=await td();return await e.getAll("face-index")},tw=async()=>{let e=await td();return await e.getAll("clip-index")},tm=async(e,t)=>{let a=(await td()).transaction(["file-status","face-index","clip-index"],"readwrite"),r=await a.objectStore("file-status").getAllKeys(),i=await a.objectStore("file-status").getAllKeys(IDBKeyRange.only("indexed")),n=new Set(e),o=new Set(t),l=new Set(r),s=new Set(i),c=e.filter(e=>!l.has(e)),d=r.filter(e=>!(n.has(e)||o.has(e)&&s.has(e)));await Promise.all([c.map(e=>a.objectStore("file-status").put(th(e))),d.map(e=>a.objectStore("file-status").delete(e)),d.map(e=>a.objectStore("face-index").delete(e)),d.map(e=>a.objectStore("clip-index").delete(e)),a.done].flat())},tp=async e=>{let t=(await td()).transaction("file-status","readonly"),a=await t.store.index("status").openKeyCursor(IDBKeyRange.only("indexable"),"prev"),r=[];for(;a&&e>0;)r.push(a.primaryKey),a=await a.continue(),e-=1;return r},tg=async e=>{var t;let a=(await td()).transaction("file-status","readwrite"),r=null!==(t=await a.store.get(e))&&void 0!==t?t:th(e);r.status="failed",r.failureCount=r.failureCount+1,await Promise.all([a.store.put(r),a.done])},ty=async()=>(await td()).getAll("face-cluster"),tb=async e=>{let t=(await td()).transaction("face-cluster","readwrite");return await t.store.clear(),await Promise.all(e.map(e=>t.store.put(e))),t.done},tv=(e,t,a)=>Math.min(a,Math.max(t,e)),tT=(e,t)=>{if(e.length!=t.length)throw Error("Length mismatch ".concat(e.length," ").concat(t.length));let a=0;for(let r=0;r<e.length;r++)a+=e[r]*t[r];return a},tE=e=>Math.sqrt(e.reduce((e,t)=>e+t*t,0)),tx=async(e,t)=>({embedding:Array.from(await tP(e.data,t))}),tP=async(e,t)=>{let{height:a,width:r,data:i}=e;return tI(await t.computeCLIPImageEmbedding(i,[a,r,4]))},tI=e=>{let t=tE(e);return e.map(e=>e/t)},tD=async(e,t)=>{let a=await t.computeCLIPTextEmbeddingIfAvailable(e);if(!a)return;let r=tI(a);return new Map((await tS()).map(e=>{let{fileID:t,embedding:a}=e;return[t,tT(a,r)]}).filter(e=>{let[,t]=e;return t>=.175}))},tS=async()=>null!=l?l:l=(await tw()).map(e=>{let{fileID:t,embedding:a}=e;return{fileID:t,embedding:new Float32Array(a)}}),tO=()=>l=void 0;var tA=a(42452),tL=a(49629);let tR="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";(0,tL.kP)(tR,22);let t_=(0,tA.k)(tR,22),tk=e=>e+t_();var tU=a(93275);let tM=async e=>{let t=new Blob([e]).stream().pipeThrough(new CompressionStream("gzip"));return new Uint8Array(await new Response(t).arrayBuffer())},tN=async e=>new Response(new Blob([e]).stream().pipeThrough(new DecompressionStream("gzip"))).text();T.z.object({id:T.z.string(),encryptedData:T.z.string().nullable(),header:T.z.string().nullable(),isDeleted:T.z.boolean(),updatedAt:T.z.number()});let tF=async(e,t,a)=>{let{encryptedData:r,decryptionHeader:i}=a;return k(await fetch(await e_("/user-entity/entity"),{method:"PUT",headers:await R(),body:JSON.stringify({id:e,type:t,encryptedData:r,header:i})}))},tz=async e=>{let t=new URLSearchParams({type:e}),a=await e_("/user-entity/key"),r=await fetch("".concat(a,"?").concat(t.toString()),{headers:await R()});if(r.ok)return tC.parse(await r.json());if(404!=r.status)throw new _(r)},tC=T.z.object({encryptedKey:T.z.string(),header:T.z.string()}),tj=async(e,t)=>{let a=await e_("/user-entity/key");k(await fetch(a,{method:"POST",headers:await R(),body:JSON.stringify({type:e,...t})}))},tB=e=>"entity/".concat(e),tG=e=>"entity/".concat(e,"/key"),tH=T.z.object({id:T.z.string(),data:T.z.object({}).passthrough(),updatedAt:T.z.number()}),tZ=async e=>{var t;return tH.array().parse(null!==(t=await I(tB(e)))&&void 0!==t?t:[])},tW=(e,t)=>A(tG(e),t),tK=e=>I(tG(e)).then(e=>e?tC.parse(e):void 0);T.z.object({name:T.z.string(),radius:T.z.number(),centerPoint:T.z.object({latitude:T.z.number(),longitude:T.z.number()})});let tq=T.z.object({id:T.z.string(),faces:T.z.string().array()}),tX=T.z.object({name:T.z.string().nullish().transform(tU.Y),assigned:T.z.array(tq),isHidden:T.z.boolean(),avatarFaceID:T.z.string().nullish().transform(tU.Y)}),tJ=()=>tZ("cgroup").then(e=>e.map(e=>({...e,data:tX.parse(e.data)}))),tQ=e=>"cgroup"==e,tV=async(e,t,a)=>{let r=await t$(e,a),i=JSON.stringify(t);return eO(tQ(e)?await tM(i):new TextEncoder().encode(i),r)},tY=async(e,t,a)=>await Promise.all(t.map(t=>{let{id:r,data:i}=t;return tV(e,i,a).then(t=>tF(r,e,t))})),t$=async(e,t)=>{let a=await tK(e);if(a)return t1(a,t);let r=await tz(e);if(r){let a=await t1(r,t);return await tW(e,r),a}let i=await t0(t),n=t1(i,t);return await tj(e,i),await tW(e,i),n},t0=async e=>{let{encryptedData:t,nonce:a}=await eS(await eD(),e);return{encryptedKey:t,header:a}},t1=async(e,t)=>eA({encryptedData:e.encryptedKey,nonce:e.header},t);var t2=a(30862),t5=a(23975),t4=a(88619);let t3=(e,t,a,r,i)=>{if(r<0||r>=t||i<0||i>=a)return{r:114,g:114,b:114,a:0};let n=(i*t+r)*4;return{r:(0,v.zx)(e[n]),g:(0,v.zx)(e[n+1]),b:(0,v.zx)(e[n+2]),a:(0,v.zx)(e[n+3])}},t8=(e,t,a,r,i)=>{let n,o,l,s,c,d,u,h,f,w,m,p,g,y,b,v,T,E,x,P,I,D,S,O,A,L,R,_,k,U,M,N,F,z,C,j,B,G,H,Z,W,K,q,X,J,Q,V,Y;e=tv(e,0,r-1),t=tv(t,0,i-1);let $=Math.trunc(e)-(e>=0?0:1),ee=$-1,et=$+1,ea=$+2,er=Math.trunc(t)-(t>=0?0:1),ei=er-1,en=er+1,eo=er+2,el=e-$,es=t-er,ec=t3(a,r,i,$,er),ed=ee<0||ei<0?ec:t3(a,r,i,ee,ei),eu=ee<0?ec:t3(a,r,i,$,ei),eh=ei<0||et>=r?ec:t3(a,r,i,et,ei),ef=ea>=r||ei<0?ec:t3(a,r,i,ea,ei),ew=(n=ed.r,(o=eu.r)+.5*(el*(-n+(l=eh.r))+el*el*(2*n-5*o+4*l-(s=ef.r))+el*el*el*(-n+3*o-3*l+s))),em=(c=ed.g,(d=eu.g)+.5*(el*(-c+(u=eh.g))+el*el*(2*c-5*d+4*u-(h=ef.g))+el*el*el*(-c+3*d-3*u+h))),ep=(f=ed.b,(w=eu.b)+.5*(el*(-f+(m=eh.b))+el*el*(2*f-5*w+4*m-(p=ef.b))+el*el*el*(-f+3*w-3*m+p))),eg=ee<0?ec:t3(a,r,i,ee,er),ey=et>=r?ec:t3(a,r,i,et,er),eb=ea>=r?ec:t3(a,r,i,ea,er),ev=(g=eg.r,(y=ec.r)+.5*(el*(-g+(b=ey.r))+el*el*(2*g-5*y+4*b-(v=eb.r))+el*el*el*(-g+3*y-3*b+v))),eT=(T=eg.g,(E=ec.g)+.5*(el*(-T+(x=ey.g))+el*el*(2*T-5*E+4*x-(P=eb.g))+el*el*el*(-T+3*E-3*x+P))),eE=(I=eg.b,(D=ec.b)+.5*(el*(-I+(S=ey.b))+el*el*(2*I-5*D+4*S-(O=eb.b))+el*el*el*(-I+3*D-3*S+O))),ex=ee<0||en>=i?ec:t3(a,r,i,ee,en),eP=en>=i?ec:t3(a,r,i,$,en),eI=et>=r||en>=i?ec:t3(a,r,i,et,en),eD=ea>=r||en>=i?ec:t3(a,r,i,ea,en),eS=(A=ex.r,(L=eP.r)+.5*(el*(-A+(R=eI.r))+el*el*(2*A-5*L+4*R-(_=eD.r))+el*el*el*(-A+3*L-3*R+_))),eO=(k=ex.g,(U=eP.g)+.5*(el*(-k+(M=eI.g))+el*el*(2*k-5*U+4*M-(N=eD.g))+el*el*el*(-k+3*U-3*M+N))),eA=(F=ex.b,(z=eP.b)+.5*(el*(-F+(C=eI.b))+el*el*(2*F-5*z+4*C-(j=eD.b))+el*el*el*(-F+3*z-3*C+j))),eL=ee<0||eo>=i?ec:t3(a,r,i,ee,eo),eR=eo>=i?ec:t3(a,r,i,$,eo),e_=et>=r||eo>=i?ec:t3(a,r,i,et,eo),ek=ea>=r||eo>=i?ec:t3(a,r,i,ea,eo),eU=(B=eL.r,(G=eR.r)+.5*(el*(-B+(H=e_.r))+el*el*(2*B-5*G+4*H-(Z=ek.r))+el*el*el*(-B+3*G-3*H+Z))),eM=(W=eL.g,(K=eR.g)+.5*(el*(-W+(q=e_.g))+el*el*(2*W-5*K+4*q-(X=ek.g))+el*el*el*(-W+3*K-3*q+X))),eN=(J=eL.b,(Q=eR.b)+.5*(el*(-J+(V=e_.b))+el*el*(2*J-5*Q+4*V-(Y=ek.b))+el*el*el*(-J+3*Q-3*V+Y)));return{r:Math.trunc(tv(ev+.5*(es*(-ew+eS)+es*es*(2*ew-5*ev+4*eS-eU)+es*es*es*(-ew+3*ev-3*eS+eU)),0,255)),g:Math.trunc(tv(eT+.5*(es*(-em+eO)+es*es*(2*em-5*eT+4*eO-eM)+es*es*es*(-em+3*eT-3*eO+eM)),0,255)),b:Math.trunc(tv(eE+.5*(es*(-ep+eA)+es*es*(2*ep-5*eE+4*eA-eN)+es*es*es*(-ep+3*eE-3*eA+eN)),0,255))}},t9=(e,t,a,r,i)=>{let{width:n,height:o,data:l}=e,s=t.map(e=>e.map(e=>1!=e?e*a:1)),c=new t2.y3([[s[0][0],s[0][1]],[s[1][0],s[1][1]]]),d=(0,t2.SO)(c),u=s[0][2],h=s[1][2],f=d.get(0,0),w=d.get(0,1),m=d.get(1,0),p=d.get(1,1);for(let e=0;e<a;++e)for(let t=0;t<a;++t){let{r:s,g:c,b:d}=t8(f*(t-u)+w*(e-h),m*(t-u)+p*(e-h),l,n,o),g=(e*a+t)*3;r[i+g]=t7(s),r[i+g+1]=t7(c),r[i+g+2]=t7(d)}},t7=e=>e/127.5-1,t6=e=>tv(Math.round((e+1)*127.5),0,255),ae=(e,t,a,r)=>{let i=t*a*r*3;return Array.from({length:r},(t,r)=>Array.from({length:a},(t,n)=>{let o=i+3*(r*a+n);return tv(Math.round(.299*t6(e[o])+.587*t6(e[o+1])+.114*t6(e[o+2])),0,255)}))},at=e=>{var t;let a=parseInt(null!==(t=e.split("_")[0])&&void 0!==t?t:"");if(isNaN(a)){b("Ignoring attempt to parse invalid faceID ".concat(e));return}return a},aa=async(e,t,a)=>{let{data:r}=t;return{width:r.width,height:r.height,faces:await ar(e.id,r,a)}},ar=async(e,t,a)=>{let{width:r,height:i}=t,n={width:r,height:i},o=await ai(t,a),l=o.map(t=>{let{box:a,landmarks:r,score:i}=t;return{faceID:ah(e,a,n),detection:{box:a,landmarks:r},score:i}}),s=l.map(e=>{let{detection:t}=e;return af(t)}),c=[],d=[];for(let e=0;e<o.length;e+=50){let r=s.slice(e,e+50),i=l.slice(e,e+50).map(e=>e.detection),n=ag(t,r);c=c.concat(await aP(n,a)),d=d.concat(ay(n,i))}return l.map((e,t)=>{let{faceID:a,detection:r,score:i}=e;return{faceID:a,detection:aI(r,n),score:i,blur:d[t],embedding:Array.from(c[t])}})},ai=async(e,t)=>{let a=e=>{let{width:t,height:a}=e;return{x:0,y:0,width:t,height:a}},{yoloInput:r,yoloSize:i}=an(e);return ad(al(ao(await t.detectFaces(r)),a(i),a(e)),.4)},an=e=>{let{width:t,height:a,data:r}=e,i=Math.min(640/t,640/a),n=tv(Math.round(t*i),0,640),o=tv(Math.round(a*i),0,640),l=new Float32Array(1228800),s=0;for(let e=0;e<640;e++)for(let c=0;c<640;c++){let{r:d,g:u,b:h}=c>=n||e>=o?{r:114,g:114,b:114}:function(e,t,a,r,i){e=tv(e,0,r-1),t=tv(t,0,i-1);let n=Math.floor(e),o=Math.ceil(e),l=Math.floor(t),s=Math.ceil(t),c=e-n,d=t-l,u=1-c,h=1-d,f=t3(a,r,i,n,l),w=t3(a,r,i,o,l),m=t3(a,r,i,n,s),p=t3(a,r,i,o,s),g=(e,t,a,r)=>Math.round(e*u*h+t*c*h+a*u*d+r*c*d);return{r:g(f.r,w.r,m.r,p.r),g:g(f.g,w.g,m.g,p.g),b:g(f.b,w.b,m.b,p.b)}}(c/i,e/i,r,t,a);l[s]=d/255,l[s+409600]=u/255,l[s+819200]=h/255,s++}return{yoloInput:l,yoloSize:{width:n,height:o}}},ao=e=>{let t=[];for(let a=0;a<e.length;a+=16){let r=e[a+4];if(r<.7)continue;let i=e[a],n=e[a+1],o=e[a+2],l=e[a+3],s=i-o/2,c=n-l/2,d=e[a+5],u=e[a+6],h=e[a+7],f=e[a+8],w=e[a+9],m=e[a+10],p=e[a+11],g=e[a+12],y=e[a+13],b=e[a+14],v={x:s,y:c,width:o,height:l},T=[{x:d,y:u},{x:h,y:f},{x:w,y:m},{x:p,y:g},{x:y,y:b}];t.push({box:v,landmarks:T,score:r})}return t},al=(e,t,a)=>{let r=as(t,a);return e.map(e=>({box:ac(e.box,r),landmarks:e.landmarks.map(e=>(0,t4.hC)(r,e)),score:e.score}))},as=(e,t)=>(0,t4.qC)((0,t4.Iu)(t.x,t.y),(0,t4.bA)(t.width/e.width,t.height/e.height)),ac=(e,t)=>{let a=(0,t4.hC)(t,{x:e.x,y:e.y}),r=(0,t4.hC)(t,{x:e.x+e.width,y:e.y+e.height});return{x:a.x,y:a.y,width:r.x-a.x,height:r.y-a.y}},ad=(e,t)=>{e.sort((e,t)=>t.score-e.score);for(let a=0;a<e.length-1;a++)for(let r=a+1;r<e.length;r++)au(e[a],e[r])>=t&&(e.splice(r,1),r--);return e},au=(e,t)=>{let a=Math.max(e.box.x,t.box.x),r=Math.max(e.box.y,t.box.y),i=Math.min(e.box.x+e.box.width,t.box.x+t.box.width),n=Math.min(e.box.y+e.box.height,t.box.y+t.box.height),o=i-a,l=n-r;if(o<0||l<0)return 0;let s=e.box.width*e.box.height,c=t.box.width*t.box.height,d=o*l;return d/(s+c-d)},ah=(e,t,a)=>{let r=e=>tv(e,0,.999999).toFixed(5).substring(2),i=r(t.x/a.width),n=r(t.y/a.height),o=r((t.x+t.width)/a.width),l=r((t.y+t.height)/a.height);return["".concat(e),i,n,o,l].join("_")},af=e=>ap(e,am(aw,ax)),aw=[[38.2946,51.6963],[73.5318,51.5014],[56.0252,71.7366],[41.5493,92.3655],[70.7299,92.2041]],am=(e,t)=>e.map(e=>{let[a,r]=e;return[a/t,r/t]}),ap=(e,t)=>{let a=new t2.y3(e.landmarks.map(e=>[e.x,e.y]).slice(0,t.length)).transpose(),r=new t2.y3(t).transpose(),i=(0,t5.p)(a,r),n=t2.y3.mul(i.rotation,i.scale),o=i.translation,l=[[n.get(0,0),n.get(0,1),o.get(0,0)],[n.get(1,0),n.get(1,1),o.get(1,0)],[0,0,1]],s=1/i.scale,c=i.toMean.sub(.5).mul(s),d=i.fromMean.sub(c),u={x:d.get(0,0),y:d.get(1,0)};return{affineMatrix:l,boundingBox:{x:u.x-s/2,y:u.y-s/2,width:s,height:s}}},ag=(e,t)=>{let a=new Float32Array(t.length*ax*ax*3);for(let r=0;r<t.length;r++){let{affineMatrix:i}=t[r],n=r*ax*ax*3;t9(e,i,ax,a,n)}return a},ay=(e,t)=>t.map((t,a)=>aE(av(ae(e,a,ax,ax),ab(t)))),ab=e=>{let{landmarks:t}=e,a=t[0],r=t[1],i=t[2],n=t[3],o=t[4],l=Math.abs(r.x-a.x),s=Math.abs(r.y-a.y),c=Math.abs(o.y-n.y),d=Math.max(a.y,r.y)+.5*s<i.y&&i.y+.5*c<Math.min(n.y,o.y),u=i.x<Math.min(a.x,r.x)&&i.x<Math.min(n.x,o.x),h=i.x>Math.max(a.x,r.x)&&i.x>Math.max(n.x,o.x),f=Math.abs(i.x-a.x)<.2*l,w=Math.abs(i.x-r.x)<.2*l;return u||d&&f?"left":h||d&&w?"right":"straight"},av=(e,t)=>{let a=aT(e,t),r=a.length-2,i=a[0].length-2,n=Array.from({length:r},()=>Array(i).fill(0)),o=[[0,1,0],[1,-4,1],[0,1,0]];for(let e=0;e<r;e++)for(let t=0;t<i;t++){let r=0;for(let i=0;i<3;i++)for(let n=0;n<3;n++)r+=a[e+i][t+n]*o[i][n];n[e][t]=r}return n},aT=(e,t)=>{let a=e.length,r=e[0].length+2-56,i=Array.from({length:a+2},()=>Array(r).fill(0));if("straight"==t)for(let t=0;t<a;t++)for(let a=0;a<r-2;a++)i[t+1][a+1]=e[t][a+Math.round(28)];else if("left"==t)for(let t=0;t<a;t++)for(let a=0;a<r-2;a++)i[t+1][a+1]=e[t][a+56];else for(let t=0;t<a;t++)for(let a=0;a<r-2;a++)i[t+1][a+1]=e[t][a];for(let e=1;e<=r-2;e++)i[0][e]=i[2][e],i[a+1][e]=i[a-1][e];for(let e=0;e<a+2;e++)i[e][0]=i[e][2],i[e][r-1]=i[e][r-3];return i},aE=e=>{let t=e.length*e[0].length,a=0;e.forEach(e=>{e.forEach(e=>{a+=e})}),a/=t;let r=0;return e.forEach(e=>{e.forEach(e=>{let t=e-a;r+=t*t})}),r/=t},ax=112,aP=async(e,t)=>{let a=await t.computeFaceEmbeddings(e),r=Array(a.length/192);for(let e=0;e<r.length;e++)r[e]=new Float32Array(a.slice(192*e,(e+1)*192));return r},aI=(e,t)=>{let{width:a,height:r}=t,i=e.box;return{box:{x:i.x/a,y:i.y/r,width:i.width/a,height:i.height/r},landmarks:e.landmarks.map(e=>({x:e.x/a,y:e.y/r}))}},aD=async(e,t,a)=>{let r=Date.now(),i=aS([...function*(e){for(let t of e)for(let e of t.faces)e.blur>10&&e.score>.8&&(yield{...e,embedding:new Float32Array(e.embedding),isBadFace:aO(e)})}(e)],t),n=[],o=(await tJ()).sort((e,t)=>t.updatedAt-e.updatedAt);n=(n=n.concat(o.map(e=>e.data.assigned).flat())).concat(await ty());let l=new Map,s=new Map;for(let[e,t]of n.entries())for(let a of t.faces)l.has(a)||(l.set(a,t.id),s.set(a,e));let c={faceIDToClusterID:l,faceIDToClusterIndex:s,clusters:n},d=i.length;for(let e=0;e<d;e+=7500)await aR(i.slice(e,e+1e4),c,t=>{let{completed:r}=t;return a({completed:e+r,total:d})});let u="(".concat(Date.now()-r," ms)");return y.ZP.info("Generated ".concat(n.length," clusters from ").concat(d," faces ").concat(u)),n},aS=(e,t)=>{let a=new Map(t.map(e=>[e.id,e])),r=new Map(e.map(e=>{let{faceID:t}=e;return[t,a.get((0,v.zx)(at(t)))]})),i=e=>{let{faceID:t}=e,a=r.get(t);return a?a.metadata.creationTime:(b("Did not find a local file for faceID ".concat(t)),0)};return e.sort((e,t)=>i(t)-i(e))},aO=e=>e.blur<50||e.blur<200&&e.blur<.85||aA(e),aA=e=>"straight"!=ab(e.detection),aL=()=>tk("cluster_"),aR=async(e,t,a)=>{let[r,i]=e.reduce((e,a)=>(e[t.faceIDToClusterID.has(a.faceID)?0:1].push(a),e),[[],[]]);if(!i.length){a({completed:e.length,total:e.length});return}let n=r.concat(i);for(let[r,i]of n.entries()){let o;if(r%100==0&&(a({completed:r,total:e.length}),await H(0)),t.faceIDToClusterID.has(i.faceID))continue;let l=0;for(let e=r-1;e>=0;e--){let t=n[e],a=tT(i.embedding,t.embedding),r=t.isBadFace?.84:.76;a>l&&a>=r&&(o=e,l=a)}if(void 0!==o){let e=(0,v.zx)(n[o]),a=(0,v.zx)(t.faceIDToClusterIndex.get(e.faceID)),r=(0,v.zx)(t.clusters[a]);t.faceIDToClusterID.set(i.faceID,r.id),t.faceIDToClusterIndex.set(i.faceID,a),r.faces.push(i.faceID)}else{let e=aL(),a=t.clusters.length,r={id:e,faces:[i.faceID]};t.faceIDToClusterID.set(i.faceID,r.id),t.faceIDToClusterIndex.set(i.faceID,a),t.clusters.push(r)}}},a_=async(e,t)=>{let a=new Map(e.map(e=>[e.id,e])),r=await tJ(),i=r.map(e=>{for(let t of e.data.assigned){let r=(0,v.zx)(a.get(t.id));if(t.faces.length!=r.faces.length)return{...e,data:{...e.data,assigned:e.data.assigned.map(e=>{let{id:t}=e;return(0,v.zx)(a.get(t))})}}}}).filter(e=>!!e);i.length&&(await tY("cgroup",i,t),y.ZP.info("Updated ".concat(i.length," remote cgroups")));let n=new Set;for(let e of r)for(let t of e.data.assigned)n.add(t.id);await tb(e.filter(e=>{let{id:t}=e;return!n.has(t)}))},ak=async(e,t)=>{let a=await em("face-crops");return Promise.all(t.faces.map(t=>{let{faceID:r,detection:i}=t;return aU(e,i.box).then(e=>a.put(r,e))}))},aU=(e,t)=>{let{width:a,height:r}=e,i=t.x*a,n=t.y*r,o=t.width*a,l=t.height*r,s=i-.4*o,c=n-.4*l,d=tv(s,0,a),u=tv(c,0,r),h=tv(1.8*o-2*Math.min(Math.abs(Math.min(0,s))/o,.4-.1)*o,0,a-d),f=tv(1.8*l-2*Math.min(Math.abs(Math.min(0,c))/l,.4-.1)*l,0,r-u),w=new OffscreenCanvas(h,f),m=(0,v.zx)(w.getContext("2d"));return m.imageSmoothingQuality="high",m.drawImage(e,d,u,h,f,0,0,h,f),w.convertToBlob({type:"image/jpeg",quality:.8})},aM=T.z.object({fileID:T.z.number(),encryptedData:T.z.string(),decryptionHeader:T.z.string()}),aN=async(e,t)=>{let a=await fetch(await e_("/files/data/fetch"),{method:"POST",headers:await R(),body:JSON.stringify({type:e,fileIDs:t})});return k(a),T.z.object({data:T.z.array(aM)}).parse(await a.json()).data},aF=async(e,t,a)=>{let{encryptedData:r,decryptionHeader:i}=await eO(a,e.key);k(await fetch(await e_("/files/data"),{method:"PUT",headers:await R(),body:JSON.stringify({fileID:e.id,type:t,encryptedData:r,decryptionHeader:i})}))},az=T.z.object({version:T.z.number(),client:T.z.string(),width:T.z.number(),height:T.z.number(),faces:T.z.array(T.z.object({faceID:T.z.string(),detection:T.z.object({box:T.z.object({x:T.z.number(),y:T.z.number(),width:T.z.number(),height:T.z.number()}),landmarks:T.z.array(T.z.object({x:T.z.number(),y:T.z.number()}))}),score:T.z.number(),blur:T.z.number(),embedding:T.z.array(T.z.number())}))}),aC=T.z.object({version:T.z.number(),client:T.z.string(),embedding:T.z.array(T.z.number())}),aj=T.z.object({}).passthrough(),aB=T.z.object({face:az.nullish().transform(tU.Y),clip:aC.nullish().transform(tU.Y)}),aG=async e=>{let t=await aN("mldata",[...e.keys()]),a=new Map;for(let r of t){let{fileID:t}=r,i=e.get(t);if(!i){y.ZP.warn("Ignoring ML data for unknown file id ".concat(t));continue}try{let e=await eL(r,i.key),n=await tN(e);a.set(t,aH(n))}catch(e){y.ZP.warn("Ignoring unparseable ML data for file id ".concat(t),e)}}return y.ZP.debug(()=>"Fetched ML data for ".concat(a.size," files")),a},aH=e=>{let t=aj.parse(JSON.parse(e)),a=aB.safeParse(t);return{raw:t,parsed:a.success?a.data:void 0}},aZ=async(e,t)=>aF(e,"mldata",await tM(JSON.stringify(t)));class aW{async init(e,t){this.electron=(0,j.Ud)(e),this.delegate=t,await e$.init(await L())}index(){let e=new Promise(e=>this.onNextIdles.push(e));return this.wakeUp(),e}wakeUp(){("init"==this.state||"idle"==this.state)&&(this.idleTimeout&&clearTimeout(this.idleTimeout),this.idleTimeout=void 0,this.state="tick",this.tick())}onUpload(e,t){this.liveQ.length<200?(this.liveQ.push({enteFile:e,uploadItem:t,remoteMLData:void 0}),this.wakeUp()):y.ZP.debug(()=>"Ignoring upload item since liveQ is full")}async clipMatches(e){return tD(e,(0,v.zx)(this.electron))}async tick(){var e,t;y.ZP.debug(()=>["ml/tick",{state:this.state,liveQ:this.liveQ,idleDuration:this.idleDuration}]);let a=()=>void setTimeout(()=>this.tick(),0),r=this.liveQ;this.liveQ=[],"fetching"!=this.state&&"indexing"!=this.state&&(this.state="indexing");let i=r.length?r:await this.backfillQ();if(this.countSinceLastIdle+=i.length,i.length>0&&await aK(i,(0,v.zx)(this.electron),this.delegate)){this.idleDuration=5,a();return}this.state="idle",this.idleDuration=Math.min(2*this.idleDuration,960),this.idleTimeout=setTimeout(a,1e3*this.idleDuration),null===(e=this.delegate)||void 0===e||e.workerDidUpdateStatus();let n=this.onNextIdles,o=this.countSinceLastIdle;this.onNextIdles=[],this.countSinceLastIdle=0,n.forEach(e=>e(o)),0==n.length&&o>0&&(null===(t=this.delegate)||void 0===t||t.workerDidUnawaitedIndex())}async backfillQ(){let e=(0,v.zx)(await O("userID")),t=await aq(e,200);if(!t.size)return[];let a=await aG(t);return"indexing"!=this.state&&"fetching"!=this.state&&b("Unexpected state ".concat(this.state)),this.state=2*a.size>t.size?"fetching":"indexing",Array.from(t,e=>{let[t,r]=e;return{enteFile:r,uploadItem:void 0,remoteMLData:a.get(t)}})}async clusterFaces(e){let t=await aD(await tf(),await e6(),e=>this.updateClusteringProgress(e));await a_(t,e),this.updateClusteringProgress(void 0)}updateClusteringProgress(e){var t;this.clusteringProgess=e,null===(t=this.delegate)||void 0===t||t.workerDidUpdateStatus()}constructor(){this.state="init",this.liveQ=[],this.idleDuration=5,this.onNextIdles=[],this.countSinceLastIdle=0}}(0,j.Jj)(aW);let aK=async(e,t,a)=>{if(!self.navigator.onLine)return y.ZP.info("Skipping ML indexing since we are not online"),!1;let r=!0,i=[,,,,].fill(void 0),n=0;for(;n<e.length;){for(let a=0;a<i.length;a++)if(n<e.length&&!i[a]){let o,l;i[a]=(o=(0,v.zx)(e[n++]),l=a,aX(o,t).then(()=>{i[l]=void 0}).catch(()=>{r=!1,i[l]=void 0}))}await Promise.race(i),null==a||a.workerDidUpdateStatus(),await H(0)}return await Promise.all(i),tO(),r},aq=async(e,t)=>{let a=new Map((await e6()).filter(t=>t.ownerID==e).map(e=>[e.id,e])),r=(await ta()).map(e=>e.id);return await tm(Array.from(a.keys()),r),new Map((await tp(t)).map(e=>[e,(0,v.zx)(a.get(e))]))},aX=async(e,t)=>{var a,r,i;let n,o,l,{enteFile:s,uploadItem:c,remoteMLData:d}=e,u=el(s),h=s.id,f=null==d?void 0:null===(a=d.parsed)||void 0===a?void 0:a.face,w=null==d?void 0:null===(r=d.parsed)||void 0===r?void 0:r.clip;if(f&&f.version>=1){let{width:e,height:t,faces:a}=f;n={width:e,height:t,faces:a}}if(w&&w.version>=1){let{embedding:e}=w;o={embedding:e}}if(n&&o){try{await tu({fileID:h,...n},{fileID:h,...o})}catch(e){throw y.ZP.error("Failed to save indexes for ".concat(u),e),e}return}let m=await tn(s,c,t);try{l=await ti(m)}catch(e){throw y.ZP.error("Failed to get image data for indexing ".concat(u),e),await tg(s.id),e}try{let e,a;let r=Date.now();try{[e,a]=await Promise.all([null!=n?n:aa(s,l,t),null!=o?o:tx(l,t)])}catch(e){throw y.ZP.error("Failed to index ".concat(u),e),await tg(s.id),e}y.ZP.debug(()=>{let t=Date.now()-r,a=[];return n||a.push("".concat(e.faces.length," faces")),o||a.push("clip"),"Indexed ".concat(a.join(" and ")," in ").concat(u," (").concat(t," ms)")});let c=null!=f?f:{version:1,client:p.SL,...e},m=null!=w?w:{version:1,client:p.SL,...a},g={...null!==(i=null==d?void 0:d.raw)&&void 0!==i?i:{},face:c,clip:m};y.ZP.debug(()=>["Uploading ML data",g]);try{await aZ(s,g)}catch(e){throw y.ZP.error("Failed to put ML data for ".concat(u),e),U(e)&&await tg(s.id),e}try{await tu({fileID:h,...e},{fileID:h,...a})}catch(e){throw y.ZP.error("Failed to save indexes for ".concat(u),e),e}if(!n)try{await ak(l.bitmap,e)}catch(e){y.ZP.error("Failed to save face crops for ".concat(u),e)}}finally{l.bitmap.close()}}},27949:function(e,t,a){"use strict";a.d(t,{MS:function(){return r},Rp:function(){return i},sH:function(){return n}});class r extends Error{constructor(e,t,a){super(e),this.name="ApiError",this.errCode=t,this.httpStatusCode=a}}function i(e){return e&&"code"in e&&"message"in e}let n={VIDEO_PLAYBACK_FAILED:"video playback failed",ETAG_MISSING:"no header/etag present in response body",KEY_MISSING:"encrypted key missing from localStorage",FAILED_TO_LOAD_WEB_WORKER:"failed to load web worker",UNSUPPORTED_FILE_FORMAT:"unsupported file format",FILE_TOO_LARGE:"file too large",SUBSCRIPTION_EXPIRED:"subscription expired",STORAGE_QUOTA_EXCEEDED:"storage quota exceeded",SESSION_EXPIRED:"session expired",INVALID_MIME_TYPE:e=>"invalid mime type -".concat(e),SIGNUP_FAILED:"signup failed",FAV_COLLECTION_MISSING:"favorite collection missing",INVALID_COLLECTION_OPERATION:"invalid collection operation",TO_MOVE_FILES_FROM_MULTIPLE_COLLECTIONS:"to move files from multiple collections",REQUEST_CANCELLED:"request canceled",REQUEST_FAILED:"request failed",TOKEN_EXPIRED:"token expired",TOKEN_MISSING:"token missing",TOO_MANY_REQUESTS:"too many requests",BAD_REQUEST:"bad request",SUBSCRIPTION_NEEDED:"subscription not present",NOT_FOUND:"not found ",NO_METADATA:"no metadata",FILE_ID_NOT_FOUND:"file with id not found",WEAK_DEVICE:"password decryption failed on the device",INCORRECT_PASSWORD:"incorrect password",UPLOAD_CANCELLED:"upload cancelled",REQUEST_TIMEOUT:"request taking too long",HIDDEN_COLLECTION_SYNC_FILE_ATTEMPTED:"hidden collection sync file attempted",UNKNOWN_ERROR:"Something went wrong, please try again",WINDOWS_NATIVE_IMAGE_PROCESSING_NOT_SUPPORTED:"Windows native image processing is not supported",NETWORK_ERROR:"Network Error",NOT_FILE_OWNER:"not file owner",UPDATE_EXPORTED_RECORD_FAILED:"update file exported record failed",EXPORT_STOPPED:"export stopped",NO_EXPORT_FOLDER_SELECTED:"no export folder selected",EXPORT_FOLDER_DOES_NOT_EXIST:"export folder does not exist",AUTH_KEY_NOT_FOUND:"auth key not found",EXIF_DATA_NOT_FOUND:"exif data not found",SELECT_FOLDER_ABORTED:"select folder aborted",PROCESSING_FAILED:"processing failed",EXPORT_RECORD_JSON_PARSING_FAILED:"export record json parsing failed",TWO_FACTOR_ENABLED:"two factor enabled",CLIENT_ERROR:"client error",ServerError:"server error",UPDATE_URL_FILE_ID_MISMATCH:"update url file id mismatch",URL_ALREADY_SET:"url already set",FILE_CONVERSION_FAILED:"file conversion failed"}}},l={};function s(e){var t=l[e];if(void 0!==t)return t.exports;var a=l[e]={exports:{}},r=!0;try{o[e].call(a.exports,a,a.exports,s),r=!1}finally{r&&delete l[e]}return a.exports}s.m=o,s.x=function(){var e=s.O(void 0,[2479,8934,7518,8742,4758,9441,545],function(){return s(64952)});return s.O(e)},e=[],s.O=function(t,a,r,i){if(a){i=i||0;for(var n=e.length;n>0&&e[n-1][2]>i;n--)e[n]=e[n-1];e[n]=[a,r,i];return}for(var o=1/0,n=0;n<e.length;n++){for(var a=e[n][0],r=e[n][1],i=e[n][2],l=!0,c=0;c<a.length;c++)o>=i&&Object.keys(s.O).every(function(e){return s.O[e](a[c])})?a.splice(c--,1):(l=!1,i<o&&(o=i));if(l){e.splice(n--,1);var d=r();void 0!==d&&(t=d)}}return t},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,{a:t}),t},s.d=function(e,t){for(var a in t)s.o(t,a)&&!s.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},s.f={},s.e=function(e){return Promise.all(Object.keys(s.f).reduce(function(t,a){return s.f[a](e,t),t},[]))},s.u=function(e){return"static/chunks/"+(({2479:"27263495",8934:"e893f787"})[e]||e)+"."+({545:"0fff9ad4d9f35a4c",2479:"49ac711006241c06",4758:"0582ec61c7ed11c0",7518:"fbe1453a695955f1",8284:"c91411dfd054f00d",8354:"d39edd5352c59560",8742:"cc6d661f3d9979ee",8934:"a38e02114c19c9f5",9441:"cff01bc5d667c994",9594:"ed6b9bc7426a3ecb"})[e]+".js"},s.miniCssF=function(e){},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.tt=function(){return void 0===t&&(t={createScriptURL:function(e){return e}},"undefined"!=typeof trustedTypes&&trustedTypes.createPolicy&&(t=trustedTypes.createPolicy("nextjs#bundler",t))),t},s.tu=function(e){return s.tt().createScriptURL(e)},s.p="/ente-group/_next/",s.b=self.location+"/../../../",a={4952:1},s.f.i=function(e,t){a[e]||importScripts(s.tu(s.p+s.u(e)))},i=(r=self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push.bind(r),r.push=function(e){var t=e[0],r=e[1],n=e[2];for(var o in r)s.o(r,o)&&(s.m[o]=r[o]);for(n&&n(s);t.length;)a[t.pop()]=1;i(e)},n=s.x,s.x=function(){return Promise.all([2479,8934,7518,8742,4758,9441,545].map(s.e,s)).then(n)},_N_E=s.x()}();